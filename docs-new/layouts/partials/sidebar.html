<div class="sidebar-menu">
  <form class="sidebar__search-form">
    <input
      type="search"
      class="sidebar__search-input"
      id="sidebar-search-input"
      placeholder="Search this site..."
      aria-label="Search this site..."
      autocomplete="off"
    />
  </form>
  <script type="text/javascript">
    // Ref: https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoView
    // Ref: https://stackoverflow.com/questions/11039885/scrollintoview-causing-the-whole-page-to-move
    (() => {
      window.addEventListener("load", function () {
        let scrollElem = document.getElementsByClassName("sidebar-nav__section-link active").item(0);
        if (scrollElem) {
         scrollElem.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
        }
        let activeSections = document.querySelectorAll(".sidebar-nav__section-link.active");
        activeSections.forEach(function (activeSection) {
          let parentCollapse = activeSection.closest(".collapse");
          if (parentCollapse) {
            parentCollapse.classList.add("show");
          }
        });
      });
    })();
  </script>

  <nav class="sidebar-nav" id="td-section-nav">
    {{ $currentPage := . }}
    {{ $pageUrl := replace .RelPermalink "/" "" }}
    {{ range $sectionIndex, $section := .Site.Data.toc }}
    <ul class="sidebar-nav__section">
      {{ $sectionUrl := replace (default "" $section.url) "/" "" }}

      <li class="sidebar-nav__section-title">
        <!-- Toggle button -->
        <div class="toggle" data-toggle="collapse" data-target="#section{{ $sectionIndex }}" aria-expanded="false" aria-controls="section{{ $sectionIndex }}"> â‡… </div>
        <a
          href="{{ if $section.url }}{{ $currentPage.Site.BaseURL }}{{ $section.url }}{{ else }}{{ $section.external_url }}{{ end }}"
          class="toggle align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section {{ if eq $pageUrl $sectionUrl }}active{{ end }}"
          data-toggle="collapse"
          data-target="#section{{ $sectionIndex }}"
          aria-expanded="false"
          aria-controls="section{{ $sectionIndex }}"
        >
          {{ $section.title }}
        </a>
  
        {{ if $section.links }}
        <ul class="td-sidebar-nav__section collapse" id="section{{ $sectionIndex }}">
          {{ range $entryIndex, $entry := $section.links }}
          {{ $entryUrl := replace (default "" $entry.url) "/" "" }}
          <li class="sidebar-nav__section-link {{ if eq $entryUrl $pageUrl }}active{{ end }}">
            <a
              href="{{ if $entry.url }}{{ $currentPage.Site.BaseURL }}{{ $entry.url }}{{ else }}{{ $entry.external_url }}{{ end }}"
              class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section"
            >{{ $entry.title }}</a>
          </li>
          {{ if or (in $currentPage.RelPermalink $entry.url) (eq $pageUrl $sectionUrl) }}
            {{ if $entry.children }}
            <ul style="margin-bottom: 0;">
              {{ range $childIndex, $child := $entry.children }}
              {{ $childUrl := cond (isset $child "url") (printf "%s%s" $currentPage.Site.BaseURL $child.url) $child.external_url }}
              {{ $childTitle := replace $childUrl "/" "" }}
              <li id="{{ anchorize $child.title }}">
                <a
                  class="sidebar-nav__section-link {{ if in $pageUrl $childTitle }}active{{ end }}"
                  id="m-{{ anchorize $section.title }}-{{ anchorize $entry.title }}-{{ anchorize $child.title }}"
                  href="{{ $childUrl }}"
                >{{ $child.title }}</a>
              </li>
              {{ if $child.grandchildren }}
              <ul style="margin-bottom: 0;">
                {{ range $grandchildIndex, $grandchild := $child.grandchildren }}
                {{ $grandchildUrl := cond (isset $grandchild "url") (printf "%s%s" $currentPage.Site.BaseURL $grandchild.url) $grandchild.external_url }}
                {{ $grandchildTitle := replace $grandchildUrl "/" "" }}
                <li id="{{ anchorize $grandchild.title }}">
                  <a
                    class="sidebar-nav__section-link {{ if in $pageUrl $grandchildTitle }}active{{ end }}"
                    id="m-{{ anchorize $section.title }}-{{ anchorize $entry.title }}-{{ anchorize $grandchild.title }}"
                    href="{{ $grandchildUrl }}"
                  ><strong style="color: var(--color-secondary-medium); font-weight: normal;">{{ $grandchild.title }}</strong></a>
                </li>
                {{ end }} <!-- grandchild -->
              </ul>
              {{ end }} <!-- end grandchildren -->
              {{ end }} <!-- children -->
            </ul>
            {{ end }} <!-- end if children -->
          {{ end }} <!-- end if pageurl -->
          {{ end }} <!-- section.links -->
        </ul>
        {{ end }} <!-- section.links -->
      </li>
    </ul> <!-- end of "sidebar-nav__section" -->
    {{ end }}
  </nav>
</div>