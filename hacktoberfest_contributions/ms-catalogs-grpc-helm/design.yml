name: MS Catalogs gRPC Microservice
version: 0.0.1
services:
  ms-catalogs-grpc-deployment:
    name: ms-catalogs-grpc
    type: Deployment
    apiVersion: apps/v1
    namespace: catalogs
    model: kubernetes
    settings:
      spec:
        replicas: 3
        selector:
          matchLabels:
            app: ms-catalogs-grpc
            version: v1
        template:
          metadata:
            labels:
              app: ms-catalogs-grpc
              version: v1
          spec:
            serviceAccountName: ms-catalogs-grpc
            containers:
            - name: ms-catalogs-grpc
              image: ms-catalogs-grpc:1.0.0
              ports:
              - containerPort: 8080
                name: grpc
                protocol: TCP
              - containerPort: 8081
                name: health
                protocol: TCP
              env:
              - name: DATABASE_URL
                valueFrom:
                  secretKeyRef:
                    name: ms-catalogs-grpc-secret
                    key: database-url
              resources:
                limits:
                  cpu: 500m
                  memory: 512Mi
                requests:
                  cpu: 200m
                  memory: 256Mi
              livenessProbe:
                httpGet:
                  path: /health
                  port: 8081
                initialDelaySeconds: 30
                periodSeconds: 10
              readinessProbe:
                httpGet:
                  path: /ready
                  port: 8081
                initialDelaySeconds: 5
                periodSeconds: 5
              volumeMounts:
              - name: config-volume
                mountPath: /config
              - name: secret-volume
                mountPath: /secrets
                readOnly: true
            volumes:
            - name: config-volume
              configMap:
                name: ms-catalogs-grpc-config
            - name: secret-volume
              secret:
                secretName: ms-catalogs-grpc-secret

  ms-catalogs-grpc-service:
    name: ms-catalogs-grpc
    type: Service
    apiVersion: v1
    namespace: catalogs
    model: kubernetes
    settings:
      spec:
        type: ClusterIP
        selector:
          app: ms-catalogs-grpc
          version: v1
        ports:
        - name: grpc
          port: 8080
          targetPort: 8080
          protocol: TCP
        - name: health
          port: 8081
          targetPort: 8081
          protocol: TCP

  ms-catalogs-grpc-config:
    name: ms-catalogs-grpc-config
    type: ConfigMap
    apiVersion: v1
    namespace: catalogs
    model: kubernetes
    settings:
      data:
        application.properties: |
          grpc.port=8080
          health.port=8081
          service.name=ms-catalogs-grpc
        grpc.config: |
          maxConnectionIdle: 300s
          maxConnectionAge: 600s
          keepaliveTime: 120s
          keepaliveTimeout: 20s

  ms-catalogs-grpc-secret:
    name: ms-catalogs-grpc-secret
    type: Secret
    apiVersion: v1
    namespace: catalogs
    model: kubernetes
    settings:
      type: Opaque
      data:
        database-url: PEJBU0U2NC1FTkNPREVELURCLVVSTD4=
        api-key: PEJBU0U2NC1FTkNPREVELUFQSS1LRVk+
        jwt-secret: PEJBU0U2NC1FTkNPREVELUpXVC1TRUNSRVQ+

  ms-catalogs-grpc-hpa:
    name: ms-catalogs-grpc
    type: HorizontalPodAutoscaler
    apiVersion: autoscaling/v2
    namespace: catalogs
    model: kubernetes
    settings:
      spec:
        scaleTargetRef:
          apiVersion: apps/v1
          kind: Deployment
          name: ms-catalogs-grpc
        minReplicas: 3
        maxReplicas: 10
        metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 70
        - type: Resource
          resource:
            name: memory
            target:
              type: Utilization
              averageUtilization: 80

  ms-catalogs-grpc-sa:
    name: ms-catalogs-grpc
    type: ServiceAccount
    apiVersion: v1
    namespace: catalogs
    model: kubernetes
    settings: {}

  catalogs-namespace:
    name: catalogs
    type: Namespace
    apiVersion: v1
    model: kubernetes
    settings:
      metadata:
        labels:
          istio-injection: enabled
          name: catalogs

  ms-catalogs-grpc-pdb:
    name: ms-catalogs-grpc
    type: PodDisruptionBudget
    apiVersion: policy/v1
    namespace: catalogs
    model: kubernetes
    settings:
      spec:
        minAvailable: 2
        selector:
          matchLabels:
            app: ms-catalogs-grpc
            version: v1
