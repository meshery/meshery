name: Release Notes Publisher

on:
  release:
    types: 'published'

permissions:
  contents: read

jobs:
  update_release_notes_docs:
      permissions:
        contents: write  # for stefanzweifel/git-auto-commit-action to push code in repo
      runs-on: ubuntu-22.04
      steps:
        - name: Harden Runner
          uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde # v2.9.1
          with:
            egress-policy: audit

        - name: Checkout
          uses: actions/checkout@61b9e3751b92087fd0b06925ba6dd6314e06f089 # master
          with:
            token: ${{ secrets.RELEASEDRAFTER_PAT }}
            ref: 'master'


        - name: Get Release Info
          run: |
            export RELEASE_TAG=$(curl -s https://api.github.com/repos/meshery/meshery/releases/latest | jq '.["tag_name"]' | tr -d '"')
            printf '%b\n' "---\nlayout: release\ndate: $(date +'%Y-%m-%d')\ntag: $RELEASE_TAG\n---\n\n`curl -s https://api.github.com/repos/meshery/meshery/releases/latest | jq -r '.["body"]'`" > ./docs/_releases/$RELEASE_TAG.md

        - name: Pull changes from remote
          run: git pull origin master

        - name: Commit
          uses: stefanzweifel/git-auto-commit-action@8621497c8c39c72f3e2a999a26b4ca1b5058a842 # v5.0.1
          with:
            file_pattern: docs
            commit_user_name: l5io
            commit_user_email: ci@layer5.io
            commit_author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
            commit_options: '--signoff'
            commit_message: '[Docs] Release Notes for Meshery ${{ steps.release_drafter.outputs.tag_name }}'
            branch: master