# =====================================================================================
# Copilot SWE Agent PR Handler
# =====================================================================================
# This workflow automatically handles pull requests created by the GitHub Copilot
# SWE Agent (https://github.com/apps/copilot-swe-agent).
#
# It performs two key actions:
# 1. Marks draft PRs as "ready for review"
# 2. Approves pending workflow runs for the PR branch
#
# This is necessary because:
# - PRs from first-time contributors (including bots) require manual approval
#   to run workflows for security reasons
# - The Copilot agent creates draft PRs that need to be marked as ready
#
# This workflow uses a scheduled trigger instead of pull_request_target to avoid
# the chicken-and-egg problem where the workflow itself would need approval
# before it could approve other workflows.
# =====================================================================================

name: Copilot PR Handler

on:
  # Run every 5 minutes to proactively find and process Copilot PRs
  # This frequency ensures timely handling of new Copilot PRs while the workflow
  # runs from the default branch without requiring approval (unlike pull_request_target)
  schedule:
    - cron: '*/5 * * * *'

  # Allow manual triggering for testing and debugging
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process (for manual testing, leave empty to process all)'
        required: false
        type: string
      debug_mode:
        description: 'Enable verbose debug logging'
        required: false
        default: false
        type: boolean

# Minimal permissions required for this workflow
# - actions: write - Required to approve workflow runs
# - pull-requests: write - Required to mark PRs as ready for review
# - contents: read - Required to access repository content
permissions:
  actions: write
  pull-requests: write
  contents: read

jobs:
  handle-copilot-prs:
    name: Handle Copilot PRs
    runs-on: ubuntu-24.04
    # Only run for the meshery/meshery repository
    if: github.repository == 'meshery/meshery'

    steps:
      # -------------------------------------------------------------------------
      # Step 1: Introspect and log all relevant context for debugging
      # -------------------------------------------------------------------------
      - name: ðŸ” Introspect Inputs and Context
        run: |
          echo "::group::Workflow Context"
          echo "Event Name: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "::endgroup::"

          echo "::group::Workflow Inputs"
          echo "PR Number (manual): ${{ inputs.pr_number || 'N/A (will process all Copilot PRs)' }}"
          echo "Debug Mode: ${{ inputs.debug_mode || 'false' }}"
          echo "::endgroup::"

      # -------------------------------------------------------------------------
      # Step 2: Find and process all Copilot PRs
      # -------------------------------------------------------------------------
      - name: ðŸ”Ž Find and Process Copilot PRs
        uses: actions/github-script@v7
        id: find-prs
        with:
          github-token: ${{ secrets.GH_ACCESS_TOKEN }}
          script: |
            const debugMode = '${{ inputs.debug_mode }}' === 'true';
            const manualPrNumber = '${{ inputs.pr_number }}' ? parseInt('${{ inputs.pr_number }}') : null;

            // Helper function for debug logging
            const debug = (msg) => {
              if (debugMode) core.info(`[DEBUG] ${msg}`);
            };

            let prsToProcess = [];

            if (manualPrNumber) {
              // Manual mode: process specific PR
              core.info(`Manual mode: Processing PR #${manualPrNumber}`);
              try {
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: manualPrNumber
                });
                prsToProcess = [pr];
              } catch (error) {
                core.warning(`Failed to fetch PR #${manualPrNumber}: ${error.message}`);
                return { processedPrs: [] };
              }
            } else {
              // Scheduled mode: find all open PRs from copilot[bot]
              core.info('Scheduled mode: Finding all open PRs from copilot[bot]...');

              try {
                // List open PRs (100 per page is sufficient for Copilot PRs which are typically few)
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  per_page: 100
                });

                debug(`Found ${prs.length} open PR(s) total`);

                // Filter for PRs from copilot[bot]
                prsToProcess = prs.filter(pr => pr.user.login === 'copilot[bot]');
                core.info(`Found ${prsToProcess.length} open PR(s) from copilot[bot]`);

                if (prsToProcess.length > 0) {
                  core.info('PRs to process:');
                  prsToProcess.forEach(pr => {
                    core.info(`  - PR #${pr.number}: ${pr.title} (draft: ${pr.draft})`);
                  });
                }
              } catch (error) {
                core.warning(`Failed to list PRs: ${error.message}`);
                return { processedPrs: [] };
              }
            }

            if (prsToProcess.length === 0) {
              core.info('No Copilot PRs found to process');
              return { processedPrs: [] };
            }

            // Store PR info for subsequent steps
            const processedPrs = prsToProcess.map(pr => ({
              number: pr.number,
              title: pr.title,
              draft: pr.draft,
              nodeId: pr.node_id,
              headSha: pr.head.sha,
              headRef: pr.head.ref
            }));

            core.setOutput('prs', JSON.stringify(processedPrs));
            return { processedPrs };

      # -------------------------------------------------------------------------
      # Step 3: Mark draft PRs as ready for review
      # -------------------------------------------------------------------------
      - name: ðŸ“ Mark Draft PRs as Ready for Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_ACCESS_TOKEN }}
          script: |
            const prsJson = '${{ steps.find-prs.outputs.prs }}';

            if (!prsJson || prsJson === '') {
              core.info('No PRs to process');
              return;
            }

            const prs = JSON.parse(prsJson);
            core.info(`Processing ${prs.length} PR(s) for draft status...`);

            for (const pr of prs) {
              if (pr.draft) {
                core.info(`Marking PR #${pr.number} as ready for review...`);

                try {
                  // Use GraphQL API to mark as ready for review
                  // The REST API doesn't support this operation
                  await github.graphql(`
                    mutation($pullRequestId: ID!) {
                      markPullRequestReadyForReview(input: {pullRequestId: $pullRequestId}) {
                        pullRequest {
                          isDraft
                        }
                      }
                    }
                  `, {
                    pullRequestId: pr.nodeId
                  });

                  core.info(`âœ… PR #${pr.number} has been marked as ready for review`);
                } catch (error) {
                  core.warning(`Failed to mark PR #${pr.number} as ready for review: ${error.message}`);
                }
              } else {
                core.info(`PR #${pr.number} is already marked as ready for review`);
              }
            }

      # -------------------------------------------------------------------------
      # Step 4: Approve pending workflow runs for Copilot PRs
      # -------------------------------------------------------------------------
      - name: âœ… Approve Pending Workflow Runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_ACCESS_TOKEN }}
          script: |
            const prsJson = '${{ steps.find-prs.outputs.prs }}';

            if (!prsJson || prsJson === '') {
              core.info('No PRs to process');
              return;
            }

            const prs = JSON.parse(prsJson);

            // Collect all head SHAs and refs for filtering
            const headShas = new Set(prs.map(pr => pr.headSha));
            const headRefs = new Set(prs.map(pr => pr.headRef));

            core.info(`Looking for pending workflow runs for ${prs.length} Copilot PR(s)...`);
            core.info(`Head SHAs: ${[...headShas].join(', ')}`);
            core.info(`Head Refs: ${[...headRefs].join(', ')}`);

            try {
              // List workflow runs that are pending approval
              // (100 per page is sufficient as Copilot typically has few concurrent PRs)
              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                status: 'action_required',
                per_page: 100
              });

              core.info(`Found ${runs.total_count} workflow run(s) awaiting approval in total`);

              // Filter runs for Copilot PR branches/SHAs
              const pendingRuns = runs.workflow_runs.filter(run => {
                const matchesSha = headShas.has(run.head_sha);
                const matchesRef = headRefs.has(run.head_branch);
                return matchesSha || matchesRef;
              });

              core.info(`Found ${pendingRuns.length} pending run(s) for Copilot PRs`);

              // Approve each pending run
              let approvedCount = 0;
              let failedCount = 0;

              for (const run of pendingRuns) {
                core.info(`Approving workflow run: ${run.name} (ID: ${run.id}, Branch: ${run.head_branch})`);

                try {
                  await github.rest.actions.approveWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                  core.info(`âœ… Approved workflow run: ${run.name} (ID: ${run.id})`);
                  approvedCount++;
                } catch (approvalError) {
                  core.warning(`Failed to approve run ${run.id}: ${approvalError.message}`);
                  failedCount++;
                }
              }

              core.info(`Summary: Approved ${approvedCount} workflow run(s), ${failedCount} failed`);

              if (pendingRuns.length === 0) {
                core.info('No pending workflow runs found for Copilot PRs');
              }
            } catch (error) {
              core.warning(`Failed to process workflow runs: ${error.message}`);
            }

      # -------------------------------------------------------------------------
      # Step 5: Post status comment on processed PRs (only on success)
      # -------------------------------------------------------------------------
      - name: ðŸ“¢ Post Status Comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_ACCESS_TOKEN }}
          script: |
            const prsJson = '${{ steps.find-prs.outputs.prs }}';

            if (!prsJson || prsJson === '') {
              core.info('No PRs to process');
              return;
            }

            const prs = JSON.parse(prsJson);

            // Comment marker to identify our comments (prevent duplicate comments)
            const commentMarker = '<!-- copilot-pr-handler-comment -->';

            for (const pr of prs) {
              try {
                // Check if we've already commented on this PR
                // (100 comments is sufficient; Copilot PRs are typically new with few comments)
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  per_page: 100
                });

                const alreadyCommented = comments.some(comment =>
                  comment.body.includes(commentMarker)
                );

                if (alreadyCommented) {
                  core.info(`PR #${pr.number} already has a status comment, skipping`);
                  continue;
                }

                const body = `${commentMarker}
            ### âœ… Copilot PR Handler

            This pull request from GitHub Copilot has been automatically processed:
            - âœ… Marked as ready for review (if it was a draft)
            - âœ… Approved pending workflow runs

            The CI checks should now run automatically.`;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: body
                });
                core.info(`Posted status comment on PR #${pr.number}`);
              } catch (error) {
                core.warning(`Failed to post status comment on PR #${pr.number}: ${error.message}`);
              }
            }
