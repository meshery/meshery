name: Validate Catalog Image Sources

on:
  pull_request:
    paths:
      - 'docs/catalog/**'
      - 'server/meshmodel/**'
      - '.github/workflows/validate-catalog-sources.yml'
      - '.github/scripts/validate-image-sources.sh'
  push:
    branches:
      - master
    paths:
      - 'docs/catalog/**'
      - 'server/meshmodel/**'
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  validate-sources:
    name: Validate Image and Chart Sources
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Bitnami validation script
        id: validate
        run: |
          bash .github/scripts/validate-image-sources.sh
        continue-on-error: true
        
      - name: Check validation result
        if: steps.validate.outcome == 'failure'
        run: |
          echo "::error::Deprecated Bitnami references detected. Please migrate to alternative sources."
          echo "::error::See docs/BITNAMI_AUDIT_REPORT.md for migration guidance."
          exit 1
          
      - name: Comment on PR (if validation fails)
        if: |
          failure() && 
          github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ‚ö†Ô∏è Deprecated Bitnami References Detected
            
            This PR contains references to deprecated Bitnami image sources.
            
            ### What happened?
            As of September 2025, Bitnami has restructured their container catalog:
            - \`docker.io/bitnami/*\` images are deprecated (except sealed-secrets)
            - \`docker.io/bitnamilegacy/*\` was archived and may be deleted
            - Most images have official upstream alternatives
            
            ### Action Required
            Please migrate to alternative image sources. Common replacements:
            
            | Deprecated | Alternative |
            |------------|-------------|
            | \`bitnami/redis\` | \`redis:7-alpine\` |
            | \`bitnami/postgresql\` | \`postgres:16-alpine\` |
            | \`bitnami/mongodb\` | \`mongo:8.0\` |
            | \`bitnami/nginx\` | \`nginx:alpine\` |
            
            ### Resources
            - üìñ [Complete Migration Guide](../docs/BITNAMI_AUDIT_REPORT.md)
            - üîó [Bitnami Announcement](https://github.com/bitnami/charts/issues/35164)
            - üîó [Issue #16072](https://github.com/meshery/meshery/issues/16072)
            
            ---
            <sub>ü§ñ This comment was automatically generated by the catalog validation workflow</sub>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
      
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bitnami-validation-report
          path: |
            docs/BITNAMI_AUDIT_REPORT.md
          retention-days: 30
