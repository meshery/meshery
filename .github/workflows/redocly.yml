name: OpenAPI Specification and Documentation
on:
  push:
    branches:
      - "master"
    paths:
      - "handlers/**"
jobs:
  redocly:
    if: github.repository == 'meshery/meshery'
    name: Generate Redocly docs
    runs-on: ubuntu-22.04
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde # v2.9.1
        with:
          egress-policy: audit

      - name: checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - name: Install Node.js
        uses: actions/setup-node@1a4442cacd436585916779262731d5b162bc6ec7 # v3.8.2
        with:
          node-version: 16
      - name: Setup go-swagger
        uses: minchao/setup-go-swagger@0be2506f6c9c8a2eff98c41d57d8d83b097d0a3b # v1
        with:
          version: v0.26.1
      - name: swagger-spec
        run: swagger generate spec -o ./server/helpers/swagger.yaml --scan-models
      - name: swagger-docs
        run: swagger generate spec -o ./docs/_data/swagger.yml --scan-models; swagger flatten ./docs/_data/swagger.yml -o ./docs/_data/swagger.yml --with-expand --format=yaml
      - name: Install dependencies
        run: npm install -g @redocly/openapi-cli
      - name: Generate documentation
        run: npx @redocly/cli build-docs ./docs/_data/swagger.yml --config='redocly.yaml'

      - name: Pull changes from remote
        run: git pull origin master

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@8621497c8c39c72f3e2a999a26b4ca1b5058a842 # v5.0.1
        with:
          file_pattern: docs
          commit_user_name: l5io
          commit_user_email: ci@layer5.io
          commit_author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          commit_options: "--signoff"
          commit_message: "[Docs] Updated Redocly docs for REST API"